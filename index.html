<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Felege Ghion Bus Ticket Booking</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; background: #f4f4f4; }
    h1 { color: #333; text-align: center; }

    #loginPage {
      display: flex; justify-content: center; align-items: center; height: 100vh;
    }
    .login-container {
      background: #fff; padding: 30px; border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1); width: 320px; text-align: center;
    }
    .login-container h2 { color: #28a745; margin-bottom: 20px; }
    .login-container input {
      width: 100%; padding: 10px; margin: 10px 0;
      border: 1px solid #ccc; border-radius: 5px;
    }
    .login-container button {
      background: #28a745; color: white; border: none; padding: 10px;
      width: 100%; cursor: pointer; border-radius: 5px; font-weight: bold;
    }
    .login-container button:hover { background: #218838; }
    .error { color: red; font-size: 0.9em; margin-top: 10px; }

    #bookingPage { display: none; padding: 20px; }
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 0 15px;
    }

    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 5px 12px;
      font-size: 13px;
      border-radius: 4px;
      cursor: pointer;
      width: auto;
    }
    .logout-btn:hover {
      background: #c82333;
    }

    .add-ticket-btn {
      background: #007bff;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      margin-bottom: 20px;
      font-weight: bold;
      display: block;
      margin-left: auto;
      margin-right: auto;
    }
    .add-ticket-btn:hover {
      background: #0069d9;
    }

    #ticketForm {
      background: #fff; padding: 20px; border-radius: 5px;
      max-width: 700px; margin: 0 auto 20px auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      display: none; /* Hidden by default */
    }
    label { display: block; margin-top: 10px; font-weight: bold; }
    input, select, textarea, button {
      width: 100%; padding: 10px; margin-top: 5px;
      border-radius: 3px; border: 1px solid #ccc; box-sizing: border-box;
    }
    button { background: #28a745; color: white; border: none; cursor: pointer; margin-top: 15px; }
    button:hover { background: #218838; }

    table {
      width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff;
    }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background: #28a745; color: white; }

    .export-section {
      background: #fff; padding: 20px; border-radius: 5px;
      max-width: 700px; margin: 20px auto; box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    .export-filters {
      display: grid;
      grid-template-columns: 1fr 1fr auto;
      gap: 10px;
      align-items: end;
    }
    .export-filters label {
      margin-top: 0;
    }
    .export-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      height: fit-content;
    }
    .export-btn:hover {
      background: #218838;
    }

    /* NEW STYLES FOR EDIT/DELETE FUNCTIONALITY */
    .action-buttons {
      display: flex;
      gap: 5px;
      justify-content: center;
    }
    
    .edit-btn {
      background: #ffc107;
      color: black;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .edit-btn:hover {
      background: #e0a800;
    }
    
    .delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 3px;
      cursor: pointer;
      font-size: 12px;
    }
    
    .delete-btn:hover {
      background: #c82333;
    }
    
    .action-buttons button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    #userInfo {
      font-weight: bold;
      color: #333;
    }
  </style>
</head>
<body>

  <!-- LOGIN PAGE -->
  <div id="loginPage">
    <div class="login-container">
      <h2>Felege Ghion Login</h2>
      <input type="text" id="username" placeholder="Username" required>
      <input type="password" id="password" placeholder="Password" required>
      <button onclick="login()">Login</button>
      <p class="error" id="error"></p>
    </div>
  </div>

  <!-- BOOKING PAGE -->
  <div id="bookingPage">
    <div class="top-bar">
      <h1>Felege Ghion Bus Transport</h1>
      <div>
        <span id="userInfo" style="margin-right: 15px;"></span>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>

    <button class="add-ticket-btn" onclick="toggleTicketForm()">Add New Ticket</button>

    <form id="ticketForm">
      <input type="hidden" id="ticketId">
      <label>Passenger Name:</label>
      <input type="text" id="name" required oninput="validateTextInput(this)">
      <label>Phone Number:</label>
      <input type="tel" id="phone" required placeholder="e.g., +251 912345678" oninput="validatePhoneInput(this)">
      <label>Origin:</label>
      <select id="origin" required><option value="">Select Origin</option></select>
      <label>Destination:</label>
      <select id="destination" required><option value="">Select Destination</option></select>
      <label>Travel Date:</label>
      <input type="date" id="date" required>
      <label>Seat Number:</label>
      <select id="seat" required><option value="">Select Seat</option></select>
      <label>Birr Amount:</label>
      <input type="text" id="amount" required oninput="validateNumberInput(this)">
      <label>Ticket Number:</label>
      <input type="text" id="ticketNumber" required>
      <label>Comment:</label>
      <textarea id="comment"></textarea>
      <button type="submit" id="submitBtn">Book Ticket</button>
      <button type="button" onclick="cancelEdit()" style="background: #6c757d;">Cancel</button>
    </form>

    <!-- Export Section -->
    <div class="export-section">
      <h3>Export Tickets to Excel</h3>
      <div class="export-filters">
        <div>
          <label>Destination:</label>
          <select id="exportDestination">
            <option value="">All Destinations</option>
          </select>
        </div>
        <div>
          <label>Travel Date:</label>
          <input type="date" id="exportDate">
        </div>
        <div>
          <button class="export-btn" id="exportBtn">Export to Excel</button>
        </div>
      </div>
    </div>

    <table id="ticketTable">
      <thead>
        <tr>
          <th>Seat Number</th><th>Name</th><th>Phone</th><th>Origin</th>
          <th>Destination</th><th>Travel Date</th><th>Birr Amount</th>
          <th>Ticket Number</th><th>Comment</th><th>Created By</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

<script>
const loginPage = document.getElementById("loginPage");
const bookingPage = document.getElementById("bookingPage");
const ticketTable = document.getElementById("ticketTable").getElementsByTagName("tbody")[0];
const ticketForm = document.getElementById("ticketForm");
const seatSelect = document.getElementById("seat");
const dateInput = document.getElementById("date");
const destinationInput = document.getElementById("destination");
const exportDestinationInput = document.getElementById("exportDestination");
const exportDateInput = document.getElementById("exportDate");
const exportBtn = document.getElementById("exportBtn");
const submitBtn = document.getElementById("submitBtn");
const userInfo = document.getElementById("userInfo");

let tickets = [];
let currentUser = null;
let isAdmin = false;
const allSeats = Array.from({ length: 52 }, (_, i) => i + 1);

// Input validation functions
function validateTextInput(input) {
  input.value = input.value.replace(/[^a-zA-Z\s\-']/g, '');
}

function validatePhoneInput(input) {
  input.value = input.value.replace(/[^\d+\-\s]/g, '');
}

function validateNumberInput(input) {
  input.value = input.value.replace(/[^\d.]/g, '');
  const decimalCount = (input.value.match(/\./g) || []).length;
  if (decimalCount > 1) {
    input.value = input.value.slice(0, -1);
  }
}

async function login() {
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  const error = document.getElementById("error");

  try {
    const response = await fetch("api/login.php", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ username, password })
    });

    const result = await response.json();

    if (result.status === "success") {
      currentUser = result.username;
      isAdmin = result.is_admin == 1;
      localStorage.setItem("loggedIn", "true");
      localStorage.setItem("username", currentUser);
      localStorage.setItem("isAdmin", isAdmin);
      
      userInfo.textContent = `Welcome, ${currentUser} ${isAdmin ? '(Admin)' : ''}`;
      loginPage.style.display = "none";
      bookingPage.style.display = "block";
      loadTickets();
    } else {
      error.textContent = result.message;
    }
  } catch (error) {
    console.error("Login error:", error);
    document.getElementById("error").textContent = "Login failed. Please try again.";
  }
}

function logout() {
  localStorage.removeItem("loggedIn");
  localStorage.removeItem("username");
  localStorage.removeItem("isAdmin");
  currentUser = null;
  isAdmin = false;
  bookingPage.style.display = "none";
  loginPage.style.display = "flex";
  ticketForm.style.display = "none";
}

function toggleTicketForm() {
  document.getElementById("ticketId").value = "";
  submitBtn.textContent = "Book Ticket";
  if (ticketForm.style.display === "none" || ticketForm.style.display === "") {
    ticketForm.style.display = "block";
  } else {
    ticketForm.style.display = "none";
    ticketForm.reset();
  }
}

function cancelEdit() {
  document.getElementById("ticketId").value = "";
  submitBtn.textContent = "Book Ticket";
  ticketForm.style.display = "none";
  ticketForm.reset();
}

window.onload = function() {
  if (localStorage.getItem("loggedIn") === "true") {
    currentUser = localStorage.getItem("username");
    isAdmin = localStorage.getItem("isAdmin") === "true";
    userInfo.textContent = `Welcome, ${currentUser} ${isAdmin ? '(Admin)' : ''}`;
    loginPage.style.display = "none";
    bookingPage.style.display = "block";
    loadTickets();
  } else {
    loginPage.style.display = "flex";
    bookingPage.style.display = "none";
  }
};

// Populate cities
document.addEventListener('DOMContentLoaded', () => {
  const originSelect = document.getElementById('origin');
  const destinationSelect = document.getElementById('destination');
  const cities = ["Addis Ababa", "Jimma", "Dilla", "Dessie", "Dire Dawa", "Alamata", "Woldia"];
  
  cities.forEach(city => {
    const o = document.createElement('option');
    o.value = city; o.textContent = city;
    originSelect.appendChild(o);
    const d = o.cloneNode(true);
    destinationSelect.appendChild(d);
  });

  const exportDestinationSelect = document.getElementById('exportDestination');
  cities.forEach(city => {
    const option = document.createElement('option');
    option.value = city; option.textContent = city;
    exportDestinationSelect.appendChild(option.cloneNode(true));
  });
});

function updateFreeSeats(editingSeat = null) {
  const date = dateInput.value;
  const destination = destinationInput.value;
  
  if (!date || !destination) {
    seatSelect.innerHTML = '<option value="">Select Seat</option>';
    return;
  }
  
  const bookedSeats = tickets
    .filter(t => t.travel_date === date && t.destination === destination)
    .map(t => parseInt(t.seat));
  
  const freeSeats = allSeats.filter(s => !bookedSeats.includes(s) || s === editingSeat);
  
  seatSelect.innerHTML = '<option value="">Select Seat</option>';
  freeSeats.forEach(seat => {
    const opt = document.createElement("option");
    opt.value = seat;
    opt.textContent = seat;
    seatSelect.appendChild(opt);
  });
  
  // Set the seat value if editing
  if (editingSeat) {
    setTimeout(() => {
      seatSelect.value = editingSeat;
    }, 100);
  }
}

dateInput.addEventListener('change', updateFreeSeats);
destinationInput.addEventListener('change', updateFreeSeats);

ticketForm.addEventListener('submit', async function(event) {
  event.preventDefault();

  const ticketId = document.getElementById("ticketId").value;
  const seat = parseInt(seatSelect.value);
  const origin = document.getElementById('origin').value;
  const destination = destinationInput.value;
  const date = dateInput.value;
  const name = document.getElementById('name').value.trim();
  const phone = document.getElementById('phone').value.trim();
  const amount = parseFloat(document.getElementById('amount').value);
  const ticketNumber = document.getElementById('ticketNumber').value.trim();
  const comment = document.getElementById('comment').value.trim();

  if (origin === destination) {
    alert("Origin and destination cannot be the same.");
    return;
  }

  const ticketData = { 
    seat, name, phone, origin, destination, date, 
    amount, ticketNumber, comment
  };

  let url = "api/tickets.php";
  let method = "POST";

  if (ticketId) {
    // Editing existing ticket
    ticketData.id = parseInt(ticketId);
    method = "PUT";
  } else {
    // Creating new ticket
    ticketData.created_by = currentUser;
  }

  try {
    const response = await fetch(url, {
      method: method,
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(ticketData)
    });

    const result = await response.json();
    console.log("Server response:", result);

    if (result.status === "success") {
      alert(result.message);
      loadTickets();
      ticketForm.reset();
      ticketForm.style.display = "none";
      document.getElementById("ticketId").value = "";
      submitBtn.textContent = "Book Ticket";
    } else {
      alert("Error: " + result.message);
    }
  } catch (error) {
    console.error("Error:", error);
    alert("Error: " + error.message);
  }
});

function editTicket(id) {
  const ticket = tickets.find(t => t.id == id);
  if (!ticket) {
    alert("Ticket not found!");
    return;
  }

  console.log("Editing ticket:", ticket);

  document.getElementById("ticketId").value = ticket.id;
  document.getElementById("name").value = ticket.name;
  document.getElementById("phone").value = ticket.phone;
  document.getElementById("origin").value = ticket.origin;
  document.getElementById("destination").value = ticket.destination;
  document.getElementById("date").value = ticket.travel_date || ticket.date;
  document.getElementById("amount").value = ticket.amount;
  document.getElementById("ticketNumber").value = ticket.ticket_number || ticket.ticketNumber;
  document.getElementById("comment").value = ticket.comment || "";

  // Update seat options and set the current seat
  updateFreeSeats(ticket.seat);

  submitBtn.textContent = "Update Ticket";
  ticketForm.style.display = "block";
  ticketForm.scrollIntoView({ behavior: 'smooth' });
}

async function deleteTicket(id) {
  if (!confirm("Are you sure you want to delete this ticket?")) {
    return;
  }

  try {
    console.log("Deleting ticket ID:", id);
    
    const response = await fetch("api/tickets.php", {
      method: "DELETE",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id: parseInt(id) })
    });

    const result = await response.json();
    console.log("Delete response:", result);

    if (result.status === "success") {
      alert(result.message);
      loadTickets();
    } else {
      alert("Error: " + result.message);
    }
  } catch (error) {
    console.error("Delete error:", error);
    alert("Error deleting ticket: " + error.message);
  }
}

function addTicketToTable(ticket) {
  const row = ticketTable.insertRow();
  row.insertCell(0).textContent = ticket.seat;
  row.insertCell(1).textContent = ticket.name;
  row.insertCell(2).textContent = ticket.phone;
  row.insertCell(3).textContent = ticket.origin;
  row.insertCell(4).textContent = ticket.destination;
  row.insertCell(5).textContent = ticket.travel_date || ticket.date;
  row.insertCell(6).textContent = ticket.amount;
  row.insertCell(7).textContent = ticket.ticket_number || ticket.ticketNumber;
  row.insertCell(8).textContent = ticket.comment || '';
  row.insertCell(9).textContent = ticket.created_by;
  
  // Actions cell
  const actionsCell = row.insertCell(10);
  const actionsDiv = document.createElement("div");
  actionsDiv.className = "action-buttons";
  
  const editButton = document.createElement("button");
  editButton.className = "edit-btn";
  editButton.textContent = "Edit";
  editButton.onclick = () => editTicket(ticket.id);
  editButton.disabled = !isAdmin && ticket.created_by !== currentUser;
  
  const deleteButton = document.createElement("button");
  deleteButton.className = "delete-btn";
  deleteButton.textContent = "Delete";
  deleteButton.onclick = () => deleteTicket(ticket.id);
  deleteButton.disabled = !isAdmin && ticket.created_by !== currentUser;
  
  actionsDiv.appendChild(editButton);
  actionsDiv.appendChild(deleteButton);
  actionsCell.appendChild(actionsDiv);
}

async function loadTickets() {
  try {
    const res = await fetch("api/tickets.php");
    if (!res.ok) {
      throw new Error(`HTTP error! status: ${res.status}`);
    }
    const data = await res.json();
    tickets = data;
    ticketTable.innerHTML = "";
    tickets.forEach(addTicketToTable);
    updateFreeSeats();
  } catch (error) {
    console.error("Error loading tickets:", error);
    alert("Error loading tickets: " + error.message);
  }
}

// Export functionality
exportBtn.addEventListener('click', async () => {
  const destination = exportDestinationInput.value;
  const date = exportDateInput.value;
  
  const params = new URLSearchParams();
  if (destination) params.append('destination', destination);
  if (date) params.append('date', date);
  
  const queryString = params.toString();
  const url = "api/tickets.php" + (queryString ? `?${queryString}` : "");
  
  try {
    const res = await fetch(url);
    const data = await res.json();
    
    if (data.length === 0) {
      alert("No tickets found for the selected filters!");
      return;
    }
    
    let filename = 'tickets';
    if (destination) filename += `_${destination.replace(/\s+/g, '_')}`;
    if (date) filename += `_${date}`;
    filename += '.xls';
    
    let tableHTML = "<table border='1'><tr><th>Seat Number</th><th>Name</th><th>Phone</th><th>Origin</th><th>Destination</th><th>Travel Date</th><th>Birr Amount</th><th>Ticket Number</th><th>Comment</th><th>Created By</th></tr>";
    data.forEach(t => {
      tableHTML += `<tr>
        <td>${t.seat}</td><td>${t.name}</td><td>${t.phone}</td><td>${t.origin}</td>
        <td>${t.destination}</td><td>${t.travel_date || t.date}</td><td>${t.amount}</td>
        <td>${t.ticket_number || t.ticketNumber}</td><td>${t.comment || ''}</td><td>${t.created_by}</td></tr>`;
    });
    tableHTML += "</table>";
    
    const blob = new Blob([tableHTML], { type: "application/vnd.ms-excel" });
    const urlBlob = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = urlBlob;
    a.download = filename;
    a.click();
    URL.revokeObjectURL(urlBlob);
  } catch (error) {
    alert("Error exporting tickets: " + error.message);
  }
});
</script>
</body>
</html>